#!/bin/bash

set -e

BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$BRANCH" != "master" ] && [ "$BRANCH" != "develop" ]; then
  echo 'This script can only be run from the master or develop branches';
  exit 1;
fi
DIST_TAG=$([ "$BRANCH" == "master" ] && echo "latest" || echo "next")

if [ -n "$(git status --porcelain)" ]; then
  echo "Please ensure your git folder is clean";
  exit 1;
fi

yarn test
yarn docs
git add -A && git commit -m 'Update docs'
if [ -n "$1" ]; then 
  $(yarn bin)/lerna version $1
  git push --tags && git push
fi
$(yarn bin)/lerna publish from-package --dist-tag $DIST_TAG --registry https://registry.npmjs.org/